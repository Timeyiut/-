<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºèƒ½æ§ç³–æ¸›é‡ç³»çµ± - æ¯æ—¥ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3063/3063822.png">
    
    <style>
        :root {
            --bg: #f2f2f7; --card: #ffffff; --primary: #007aff;
            --safe: #34c759; --warn: #ff9500; --danger: #ff3b30;
            --text: #1c1c1e; --subtext: #8e8e93;
        }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; padding: 15px; color: var(--text); }
        .container { max-width: 600px; margin: 0 auto; }
        .card { background: var(--card); border-radius: 15px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 15px; }
        h1 { font-size: 1.4rem; text-align: center; color: var(--primary); margin: 10px 0 20px; }
        h2 { font-size: 1rem; margin-top: 0; display: flex; align-items: center; gap: 8px; }
        
        .input-grid { display: grid; grid-template-columns: repeat(2,1fr); gap: 10px; }
        .input-group { margin-bottom: 12px; }
        label { display: block; font-size: 0.85rem; color: var(--subtext); margin-bottom: 5px; }
        input, select { 
            width: 100%; padding: 10px; border: 1px solid #d1d1d6; border-radius: 10px; 
            font-size: 1rem; box-sizing: border-box; outline: none;
        }
        
        button { 
            width: 100%; padding: 12px; background: var(--primary); color: white; 
            border: none; border-radius: 12px; font-weight: 600; font-size: 1rem; margin-top: 10px;
        }

        .result-box { display: none; border-top: 4px solid var(--primary); }
        .macro-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .macro-item { background: #f8f9ff; padding: 10px; border-radius: 8px; text-align: center; }
        .macro-label { font-size: 0.75rem; color: var(--subtext); }
        .macro-val { font-weight: bold; font-size: 0.9rem; color: var(--primary); }

        .tip-box { background: #fff9e6; border-radius: 10px; padding: 12px; font-size: 0.85rem; color: #856404; margin-top: 15px; border: 1px solid #ffe58f; }
        
        /* åœ–è¡¨æ¨£å¼ */
        .chart-container { height: 260px; margin-top: 10px; }
        .btn-danger { background: #ff3b30; margin-top: 20px; font-size: 0.8rem; padding: 8px; opacity: 0.9; color: white; border-radius: 10px; border: none; }
        .small { font-size: 0.85rem; color: var(--subtext); }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“ˆ æ™ºèƒ½æ¸›é‡å‹•æ…‹ç›£æ¸¬ç³»çµ±</h1>

    <div class="card">
        <h2>ğŸ‘¤ å€‹äººè³‡æ–™</h2>
        <div class="input-grid">
            <div class="input-group">
                <label>èº«é«˜ (cm)</label>
                <input type="number" id="height" placeholder="167">
            </div>
            <div class="input-group">
                <label>å¹´é½¡ (æ­²)</label>
                <input type="number" id="age" placeholder="33">
            </div>
            <div class="input-group">
                <label>ç”Ÿç†/æ€§åˆ¥</label>
                <select id="sex">
                    <option value="male">ç”·æ€§</option>
                    <option value="female">å¥³æ€§</option>
                </select>
            </div>
            <div class="input-group">
                <label>æ´»å‹•å¼·åº¦</label>
                <select id="activity">
                    <option value="1.2">ä¹…å / è¼•åº¦æ´»å‹• (1.2)</option>
                    <option value="1.375">è¼•åº¦æ´»å‹• (1.375)</option>
                    <option value="1.55">ä¸­åº¦æ´»å‹• (1.55)</option>
                    <option value="1.725">é«˜åº¦æ´»å‹• (1.725)</option>
                </select>
            </div>
        </div>
        <div style="display:flex; gap:10px; margin-top:8px;">
            <button id="saveProfileBtn" onclick="saveProfile()">å„²å­˜å€‹äººè¨­å®š</button>
            <button style="width:auto; padding:10px;" onclick="loadDefaultProfile()" class="small">è¼‰å…¥é è¨­</button>
        </div>
    </div>

    <div class="card">
        <h2>ğŸ—“ï¸ ä»Šæ—¥æ•¸æ“šéŒ„å…¥</h2>
        <div class="input-grid">
            <div class="input-group">
                <label>ä»Šæ—¥é«”é‡ (kg)</label>
                <input type="number" id="weight" step="0.1" placeholder="90.0">
            </div>
            <div class="input-group">
                <label>ä»Šæ—¥ Garmin é‹å‹•æ¶ˆè€— (kcal)</label>
                <input type="number" id="garmin" placeholder="300">
            </div>
            <div class="input-group">
                <label>ä»Šæ—¥ FatSecret æ”å– (kcal)</label>
                <input type="number" id="fatsecret" placeholder="2000">
            </div>
            <div style="align-self:end;" class="input-group">
                <button onclick="saveAndCalculate()">å„²å­˜ä¸¦è¨ˆç®—ä»Šæ—¥æ–¹é‡</button>
            </div>
        </div>
    </div>

    <div class="card">
        <h2>ğŸ“‰ é«”é‡è®ŠåŒ–è¶¨å‹¢</h2>
        <div class="chart-container">
            <canvas id="weightChart"></canvas>
        </div>
    </div>

    <div class="card result-box" id="resultArea">
        <h2>ğŸ¯ æ¯æ—¥æ»¾å‹•ä¿®æ­£æ–¹é‡</h2>
        <div style="font-size: 0.9rem;">é ä¼°æ¯æ—¥åŸºç¤ä»£è¬ (BMR): <span id="bmrDisplay">0</span> kcal</div>
        <div style="font-size: 0.9rem;">é ä¼°æ¯æ—¥ç¸½æ¶ˆè€— (TDEE): <span id="tdeeDisplay">0</span> kcal</div>
        <div style="font-size: 1.2rem; font-weight: bold; margin-top: 5px;">å»ºè­°æ”å–ï¼š<span id="targetIntake">0</span> kcal</div>
        
        <div class="macro-grid">
            <div class="macro-item"><div class="macro-label">ç¢³æ°´(40%)</div><div class="macro-val" id="carb">0g</div></div>
            <div class="macro-item"><div class="macro-label">è›‹ç™½(30%)</div><div class="macro-val" id="pro">0g</div></div>
            <div class="macro-item"><div class="macro-label">è„‚è‚ª(30%)</div><div class="macro-val" id="fat">0g</div></div>
        </div>

        <div class="tip-box" id="diabetesTip"></div>
    </div>

    <button class="btn-danger" onclick="clearHistory()">é‡ç½®æ‰€æœ‰ç´€éŒ„</button>
</div>

<script>
let myChart;

/* ---------- å­˜å–èˆ‡æ ¼å¼åŒ–æ­·å²è³‡æ–™ ---------- */
/**
 * å–å¾—æ­·å²ç´€éŒ„ï¼Œä¸¦å˜—è©¦å°‡èˆŠæ ¼å¼æ—¥æœŸé·ç§»åˆ° ISO (YYYY-MM-DD)
 */
function getHistory() {
    const raw = JSON.parse(localStorage.getItem('diet_history') || '[]');
    return raw.map(item => {
        if (!item || !item.date) return item;
        // è‹¥å·²æ˜¯ ISO å°±ä¸å‹•ï¼Œè‹¥å« '/' å˜—è©¦è§£æ
        if (item.date.indexOf('/') !== -1) {
            const d = new Date(item.date);
            if (!isNaN(d)) item.date = d.toISOString().slice(0,10);
        }
        return item;
    });
}

function saveHistory(history) {
    // ç¢ºä¿æ—¥æœŸæ­£è¦åŒ–ç‚º YYYY-MM-DD
    const norm = history.map(h => {
        if (h.date && h.date.indexOf('/') !== -1) {
            const d = new Date(h.date);
            if (!isNaN(d)) h.date = d.toISOString().slice(0,10);
        }
        return h;
    });
    localStorage.setItem('diet_history', JSON.stringify(norm));
}

/* ---------- å€‹äººè¨­å®šï¼ˆprofileï¼‰ ---------- */
function loadProfile() {
    const raw = JSON.parse(localStorage.getItem('diet_profile') || '{}');
    return {
        height: raw.height || 167,
        age: raw.age || 33,
        sex: raw.sex || 'male',
        activity: raw.activity || 1.2
    };
}

function saveProfile() {
    const h = parseFloat(document.getElementById('height').value) || 167;
    const a = parseInt(document.getElementById('age').value) || 33;
    const s = document.getElementById('sex').value;
    const act = parseFloat(document.getElementById('activity').value) || 1.2;
    const profile = { height: h, age: a, sex: s, activity: act };
    localStorage.setItem('diet_profile', JSON.stringify(profile));
    alert('å·²å„²å­˜å€‹äººè¨­å®š');
}

function loadDefaultProfile() {
    const p = loadProfile();
    document.getElementById('height').value = p.height;
    document.getElementById('age').value = p.age;
    document.getElementById('sex').value = p.sex;
    document.getElementById('activity').value = p.activity;
}

/* ---------- å•Ÿå‹•æ™‚è™•ç† ---------- */
window.onload = function() {
    loadChart();
    loadDefaultProfile();
    // è‡ªå‹•å¡«å…¥æœ€å¾Œä¸€æ¬¡éŒ„å…¥çš„é«”é‡ï¼ˆå¦‚æœæœ‰ï¼‰
    const history = getHistory();
    if (history.length > 0) {
        const last = history[history.length - 1];
        if (last && Number.isFinite(Number(last.w))) {
            document.getElementById('weight').value = last.w;
        }
    }
};

/* ---------- ä¸»è¦è¨ˆç®—èˆ‡ UI æ›´æ–° ---------- */
function saveAndCalculate() {
    const w = parseFloat(document.getElementById('weight').value);
    const g = parseFloat(document.getElementById('garmin').value) || 0;
    const f = parseFloat(document.getElementById('fatsecret').value) || 0;

    const profile = loadProfile();
    const h = Number(profile.height);
    const age = Number(profile.age);
    const sex = profile.sex;
    const activity = Number(profile.activity);

    const today = new Date().toISOString().slice(0,10); // YYYY-MM-DD

    if (!Number.isFinite(w) || w <= 0) return alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„é«”é‡ï¼ˆå¤§æ–¼ 0 çš„æ•¸å­—ï¼‰");
    if (!Number.isFinite(h) || h <= 0) return alert("è«‹å…ˆå„²å­˜æˆ–è¼¸å…¥æœ‰æ•ˆçš„èº«é«˜");
    if (!Number.isFinite(age) || age <= 0) return alert("è«‹å…ˆå„²å­˜æˆ–è¼¸å…¥æœ‰æ•ˆçš„å¹´é½¡");

    // æ›´æ–°æ­·å²ç´€éŒ„
    let history = getHistory();
    const existingIndex = history.findIndex(item => item.date === today);
    if (existingIndex > -1) {
        history[existingIndex] = { date: today, w: w, g: g, f: f };
    } else {
        history.push({ date: today, w: w, g: g, f: f });
    }
    // åªä¿ç•™æœ€è¿‘ 30 å¤©ç´€éŒ„
    if (history.length > 30) history = history.slice(history.length - 30);
    saveHistory(history);

    // BMRï¼ˆMifflinâ€“St Jeorï¼‰
    // ç”·æ€§: +5 ; å¥³æ€§: -161
    const s = (sex === 'male') ? 5 : -161;
    const bmr = 10 * w + 6.25 * h - 5 * age + s;
    const tdee = bmr * activity + g;
    let target = Math.max(bmr, tdee - 500);

    // UI é¡¯ç¤º
    document.getElementById('resultArea').style.display = 'block';
    document.getElementById('bmrDisplay').innerText = Math.round(bmr);
    document.getElementById('tdeeDisplay').innerText = Math.round(tdee);
    document.getElementById('targetIntake').innerText = Math.round(target);
    document.getElementById('carb').innerText = Math.round(target*0.4/4) + "g";
    document.getElementById('pro').innerText = Math.round(target*0.3/4) + "g";
    document.getElementById('fat').innerText = Math.round(target*0.3/9) + "g";

    // ç³–å°¿ç—…æé†’
    const tip = document.getElementById('diabetesTip');
    if (g > 500) {
        tip.innerHTML = "<b>âš ï¸ é«˜å¼·åº¦æé†’ï¼š</b> é‹å‹•é‡è¼ƒå¤§ï¼Œé‹å‹•å‰è‹¥è¡€ç³–ä½æ–¼ 110 mg/dLï¼Œè«‹è£œå…… 15g å¿«é†£ã€‚";
    } else {
        tip.innerHTML = "<b>ğŸ’¡ ç‡Ÿé¤Šå®åš€ï¼š</b> ä¿æŒä½ GI é€²é£Ÿé †åºï¼šçº–ç¶­è³ª â†’ è›‹ç™½è³ª â†’ æ¾±ç²‰ã€‚";
    }

    updateChart();
}

/* ---------- åœ–è¡¨ç›¸é—œ ---------- */
function formatLabelFromDate(isoDate) {
    try {
        const d = new Date(isoDate);
        if (!isNaN(d)) {
            return (d.getMonth()+1) + '-' + String(d.getDate()).padStart(2,'0');
        }
    } catch(e){}
    return isoDate || '';
}

function loadChart() {
    const ctx = document.getElementById('weightChart').getContext('2d');
    const history = getHistory();

    const labels = history.map(h => formatLabelFromDate(h.date));
    const data = history.map(h => h.w);

    myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'é«”é‡ (kg)',
                data: data,
                borderColor: '#007aff',
                backgroundColor: 'rgba(0, 122, 255, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.3,
                pointRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: false }
            }
        }
    });
}

function updateChart() {
    const history = getHistory();
    if (!myChart) { loadChart(); return; }
    myChart.data.labels = history.map(h => formatLabelFromDate(h.date));
    myChart.data.datasets[0].data = history.map(h => h.w);
    myChart.update();
}

/* ---------- æ¸…é™¤èˆ‡è¼”åŠ© ---------- */
function clearHistory() {
    if(confirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰æ­·å²ç´€éŒ„å—ï¼Ÿ")) {
        localStorage.removeItem('diet_history');
        location.reload();
    }
}
</script>
</body>
</html>
