<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºèƒ½æ§ç³–æ¸›é‡ç³»çµ± - æ¯æ—¥ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3063/3063822.png">
    
    <style>
        :root {
            --bg: #f2f2f7; --card: #ffffff; --primary: #007aff;
            --safe: #34c759; --warn: #ff9500; --danger: #ff3b30;
            --text: #1c1c1e; --subtext: #8e8e93;
        }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; padding: 15px; color: var(--text); }
        .container { max-width: 500px; margin: 0 auto; }
        .card { background: var(--card); border-radius: 15px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 15px; }
        h1 { font-size: 1.4rem; text-align: center; color: var(--primary); margin: 10px 0 20px; }
        h2 { font-size: 1rem; margin-top: 0; display: flex; align-items: center; gap: 8px; }
        
        .input-group { margin-bottom: 12px; }
        label { display: block; font-size: 0.85rem; color: var(--subtext); margin-bottom: 5px; }
        input { 
            width: 100%; padding: 12px; border: 1px solid #d1d1d6; border-radius: 10px; 
            font-size: 1rem; box-sizing: border-box; outline: none;
        }
        
        button { 
            width: 100%; padding: 15px; background: var(--primary); color: white; 
            border: none; border-radius: 12px; font-weight: 600; font-size: 1rem; margin-top: 10px;
        }

        .result-box { display: none; border-top: 4px solid var(--primary); }
        .macro-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .macro-item { background: #f8f9ff; padding: 10px; border-radius: 8px; text-align: center; }
        .macro-label { font-size: 0.75rem; color: var(--subtext); }
        .macro-val { font-weight: bold; font-size: 0.9rem; color: var(--primary); }

        .tip-box { background: #fff9e6; border-radius: 10px; padding: 12px; font-size: 0.85rem; color: #856404; margin-top: 15px; border: 1px solid #ffe58f; }
        
        /* åœ–è¡¨æ¨£å¼ */
        .chart-container { height: 250px; margin-top: 10px; }
        .btn-danger { background: #ff3b30; margin-top: 20px; font-size: 0.8rem; padding: 8px; opacity: 0.7; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“ˆ æ™ºèƒ½æ¸›é‡å‹•æ…‹ç›£æ¸¬ç³»çµ±</h1>

    <div class="card">
        <h2>ğŸ—“ï¸ ä»Šæ—¥æ•¸æ“šéŒ„å…¥</h2>
        <div class="input-group">
            <label>ä»Šæ—¥é«”é‡ (kg)</label>
            <input type="number" id="weight" step="0.1" placeholder="90.0">
        </div>
        <div class="input-group">
            <label>ä»Šæ—¥ Garmin é‹å‹•æ¶ˆè€— (kcal)</label>
            <input type="number" id="garmin" placeholder="300">
        </div>
        <div class="input-group">
            <label>ä»Šæ—¥ FatSecret æ”å– (kcal)</label>
            <input type="number" id="fatsecret" placeholder="2000">
        </div>
        <button onclick="saveAndCalculate()">å„²å­˜ä¸¦è¨ˆç®—ä»Šæ—¥æ–¹é‡</button>
    </div>

    <div class="card">
        <h2>ğŸ“‰ é«”é‡è®ŠåŒ–è¶¨å‹¢</h2>
        <div class="chart-container">
            <canvas id="weightChart"></canvas>
        </div>
    </div>

    <div class="card result-box" id="resultArea">
        <h2>ğŸ¯ æ¯æ—¥æ»¾å‹•ä¿®æ­£æ–¹é‡</h2>
        <div style="font-size: 0.9rem;">é ä¼°æ¯æ—¥ç¸½æ¶ˆè€— (TDEE): <span id="tdeeDisplay">0</span> kcal</div>
        <div style="font-size: 1.2rem; font-weight: bold; margin-top: 5px;">å»ºè­°æ”å–ï¼š<span id="targetIntake">0</span> kcal</div>
        
        <div class="macro-grid">
            <div class="macro-item"><div class="macro-label">ç¢³æ°´(40%)</div><div class="macro-val" id="carb">0g</div></div>
            <div class="macro-item"><div class="macro-label">è›‹ç™½(30%)</div><div class="macro-val" id="pro">0g</div></div>
            <div class="macro-item"><div class="macro-label">è„‚è‚ª(30%)</div><div class="macro-val" id="fat">0g</div></div>
        </div>

        <div class="tip-box" id="diabetesTip"></div>
    </div>

    <button class="btn-danger" onclick="clearHistory()">é‡ç½®æ‰€æœ‰ç´€éŒ„</button>
</div>

<script>
let myChart;

window.onload = function() {
    loadChart();
    // è‡ªå‹•å¡«å…¥æœ€å¾Œä¸€æ¬¡éŒ„å…¥çš„é«”é‡
    const history = getHistory();
    if (history.length > 0) {
        document.getElementById('weight').value = history[history.length - 1].w;
    }
};

function getHistory() {
    return JSON.parse(localStorage.getItem('diet_history') || '[]');
}

function saveAndCalculate() {
    const w = parseFloat(document.getElementById('weight').value);
    const g = parseFloat(document.getElementById('garmin').value) || 0;
    const f = parseFloat(document.getElementById('fatsecret').value) || 0;
    const today = new Date().toLocaleDateString();

    if(!w) return alert("è«‹è¼¸å…¥é«”é‡");

    // æ›´æ–°æ­·å²ç´€éŒ„
    let history = getHistory();
    const existingIndex = history.findIndex(item => item.date === today);
    if (existingIndex > -1) {
        history[existingIndex] = { date: today, w: w, g: g, f: f };
    } else {
        history.push({ date: today, w: w, g: g, f: f });
    }
    // åªä¿ç•™æœ€è¿‘ 30 å¤©ç´€éŒ„
    if (history.length > 30) history.shift();
    localStorage.setItem('diet_history', JSON.stringify(history));

    // è¨ˆç®—é‚è¼¯
    const bmr = 10 * w + 6.25 * 167 - 5 * 33 + 5;
    const tdee = bmr * 1.2 + g;
    let target = Math.max(bmr, tdee - 500);

    // UI é¡¯ç¤º
    document.getElementById('resultArea').style.display = 'block';
    document.getElementById('tdeeDisplay').innerText = Math.round(tdee);
    document.getElementById('targetIntake').innerText = Math.round(target);
    document.getElementById('carb').innerText = Math.round(target*0.4/4) + "g";
    document.getElementById('pro').innerText = Math.round(target*0.3/4) + "g";
    document.getElementById('fat').innerText = Math.round(target*0.3/9) + "g";

    // ç³–å°¿ç—…æé†’
    const tip = document.getElementById('diabetesTip');
    if (g > 500) {
        tip.innerHTML = "<b>âš ï¸ é«˜å¼·åº¦æé†’ï¼š</b> é‹å‹•é‡è¼ƒå¤§ï¼Œé‹å‹•å‰è‹¥è¡€ç³–ä½æ–¼ 110 mg/dLï¼Œè«‹è£œå…… 15g å¿«é†£ã€‚";
    } else {
        tip.innerHTML = "<b>ğŸ’¡ ç‡Ÿé¤Šå®åš€ï¼š</b> ä¿æŒä½ GI é€²é£Ÿé †åºï¼šçº–ç¶­è³ª â†’ è›‹ç™½è³ª â†’ æ¾±ç²‰ã€‚";
    }

    updateChart();
}

function loadChart() {
    const ctx = document.getElementById('weightChart').getContext('2d');
    const history = getHistory();
    
    myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: history.map(h => h.date.split('/')[2]), // åªé¡¯ç¤ºæ—¥æœŸ
            datasets: [{
                label: 'é«”é‡ (kg)',
                data: history.map(h => h.w),
                borderColor: '#007aff',
                backgroundColor: 'rgba(0, 122, 255, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: false }
            }
        }
    });
}

function updateChart() {
    const history = getHistory();
    myChart.data.labels = history.map(h => h.date.split('/')[2]);
    myChart.data.datasets[0].data = history.map(h => h.w);
    myChart.update();
}

function clearHistory() {
    if(confirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰æ­·å²ç´€éŒ„å—ï¼Ÿ")) {
        localStorage.removeItem('diet_history');
        location.reload();
    }
}
</script>
</body>
</html>
